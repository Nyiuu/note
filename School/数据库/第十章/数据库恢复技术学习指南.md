# 数据库恢复技术学习指南 - 第十章

本指南旨在帮助您理解和记忆《数据库系统概论》第十章的核心概念：数据库恢复技术。

---

## 1. 事务 (Transaction)

**事务**是用户定义的一个数据库操作序列，这些操作要么全做，要么全不做，是一个不可分割的工作单位。事务是恢复和并发控制的基本单位。

### 1.1. 事务的ACID特性

ACID特性是保证事务正确执行的四个基本要素。

*   **A - 原子性 (Atomicity)**
    *   **定义**: 事务是原子的，即事务中的所有操作要么全部成功提交，要么全部失败回滚。数据库永远不会停留在事务执行的中间状态。
    *   **记忆点**: "all or nothing"（全有或全无）。
    *   **保证方式**: 通过**恢复技术**来保证。如果事务在执行过程中失败，恢复系统会**撤销(UNDO)**该事务所做的所有修改，使其回到初始状态。

*   **C - 一致性 (Consistency)**
    *   **定义**: 事务执行的结果必须是使数据库从一个一致性状态转变到另一个一致性状态。如果事务成功完成，那么所有内部数据结构（如B树索引或双向链表）都必须是正确的。
    *   **记忆点**: 数据的完整性约束（如主键、外键）在事务执行前后都必须保持满足。
    *   **保证方式**: 通常由应用程序和数据库的**完整性约束**共同保证。原子性、隔离性、持久性也是为了保证一致性。

*   **I - 隔离性 (Isolation)**
    *   **定义**: 一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰。
    *   **记忆点**: 就像多个事务在各自独立的"房间"里运行，互不影响。
    *   **保证方式**: 通过**并发控制技术**（如锁机制）来保证。

*   **D - 持久性 (Durability)**
    *   **定义**: 一旦事务成功提交，它对数据库中数据的改变就应该是永久性的。接下来的其他操作或故障不应该对其有任何影响。
    *   **记忆点**: 提交了就不能丢。
    *   **保证方式**: 通过**恢复技术**来保证。通过将事务的更新记录在**日志文件**中，即使系统崩溃，也能通过日志恢复已提交的修改。

---

## 2. 故障的种类

数据库系统中的故障是不可避免的。了解故障的类型是设计恢复策略的基础。

1.  **事务内部的故障**
    *   **描述**: 事务在运行过程中，由于程序本身的原因（如被零除、无效的输入、死锁等）未能正常执行到结束。这是最常见的一类故障。
    *   **影响**: 仅影响当前事务，不会破坏数据库。
    *   **恢复措施**: **事务回滚 (UNDO)**。系统需要撤销该事务已经对数据库进行的修改。

2.  **系统级故障（软故障）**
    *   **描述**: 指造成系统停止运转的任何事件，使得系统要重新启动。例如，CPU故障、操作系统崩溃、突然断电等。
    *   **影响**:
        *   内存中的信息全部丢失，包括数据库缓冲区。
        *   所有正在运行的事务都非正常终止。
        *   存储在外存（磁盘）上的数据库数据本身不会被破坏。
    *   **恢复措施**:
        *   系统重启后，需要**撤销 (UNDO)**所有在故障发生时**未完成**的事务。
        *   需要**重做 (REDO)**所有在故障发生时**已提交**但其修改可能还留在缓冲区、未完全写入磁盘的事务。

3.  **介质故障（硬故障）**
    *   **描述**: 指外存（磁盘）发生的故障，如磁头损坏、磁盘损坏、瞬间的强磁场干扰等。这是最严重的一类故障。
    *   **影响**: 破坏数据库的全部或部分数据，以及存储在磁盘上的日志文件。
    *   **恢复措施**:
        *   **装入数据库的最新后备副本**（即最近一次转储的备份）。
        *   **重做 (REDO)**自该副本之后所有**已提交**的事务，将数据库恢复到故障前的状态。

---

## 3. 故障的恢复技术

恢复技术的核心是**数据冗余**。通过利用冗余数据来重建被破坏的数据库。主要的两种技术是**数据转储**和**登记日志文件**。

### 3.1. 数据转储 (Backup)

*   **定义**: DBA定期地将整个数据库复制到磁带、磁盘或其他存储介质上保存起来的过程。这些备用的数据文本称为后备副本或转储副本。
*   **用途**: 主要用于**介质故障**的恢复。
*   **分类**:
    *   **静态转储**: 在系统中无事务运行时进行。转储期间不允许对数据库进行任何操作。优点是实现简单，但会降低数据库可用性。
    *   **动态转储**: 在系统正常运行时进行。转储期间允许对数据库进行操作。优点是提高了可用性，但实现复杂，需要结合日志文件才能恢复。
    *   **海量转储**: 每次转储全部数据库。
    *   **增量转储**: 每次只转储上次转储后更新过的数据。

### 3.2. 登记日志文件 (Logging)

*   **定义**: 日志文件是用来记录事务对数据库的**所有更新操作**的文件。
*   **用途**: 用于**所有类型故障**的恢复，尤其是**事务故障**和**系统故障**。
*   **日志记录的格式**:
    *   以记录为单位，每个记录描述一次更新操作。
    *   内容通常包括：事务标识、操作类型（增、删、改）、操作对象、前像（更新前的值）、后像（更新后的值）。
*   **登记日志的基本原则**:
    *   **`[写日志]` 操作必须先于 `[写数据]` 操作**。在事务对数据项进行修改写入数据库缓冲区之前，必须先将对应的日志记录写入日志文件。
    *   **`[提交日志]` 操作必须先于 `[提交确认]` 操作**。当事务提交时，必须先将包含事务提交的日志记录写入日志文件，然后才能向用户发出提交成功的响应。这被称为"**预写式日志 (Write-Ahead Logging, WAL)**"策略，是保证持久性的关键。

### 3.3. 恢复策略

*   **事务故障的恢复**:
    *   由系统自动完成，不需要用户干预。
    *   **方法**: 反向扫描该事务的日志记录，对该事务的每个更新操作执行其**逆操作 (UNDO)**，直到事务的开始标记。

*   **系统故障的恢复**:
    *   系统重启后自动完成，不需要用户干预。
    *   **方法**:
        1.  **正向扫描日志**:
            *   找出在故障发生前已经提交的事务队列 (T_commit)。
            *   找出在故障发生前尚未完成的事务队列 (T_incomplete)。
        2.  **处理未完成事务**: 对 T_incomplete 队列中的每个事务执行 **UNDO** 操作。
        3.  **处理已提交事务**: 对 T_commit 队列中的每个事务执行 **REDO** 操作。

*   **介质故障的恢复**:
    *   需要 DBA 介入。
    *   **方法**:
        1.  DBA 装入最新的数据库后备副本，使数据库恢复到**上一次转储时**的一致性状态。
        2.  DBA 装入转储结束后的日志文件副本。
        3.  系统执行恢复程序，**正向扫描日志文件**，对所有**已提交**的事务执行 **REDO** 操作，将数据库恢复到故障发生前的某一时刻。 